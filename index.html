<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ASEAN CURRENCY PRO - KELOMPOK 4</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --primary-glow: #8b5cf6;
            --secondary-glow: #6366f1;
            --accent-color: #10b981;
            --bg-dark: #070514;
            --card-bg: rgba(20, 18, 50, 0.9);
        }

        body {
            background-color: var(--bg-dark);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #ffffff;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; margin: 0;
            overflow-x: hidden;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 2rem; width: 100%; max-width: 500px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card.wide { max-width: 900px; }

        .header-title {
            font-weight: 800; text-align: center; margin-bottom: 1.5rem;
            background: linear-gradient(to right, #a78bfa, #818cf8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        #media-container {
            width: 100%; border-radius: 20px; overflow: hidden; 
            border: 2px solid var(--primary-glow); position: relative; 
            background: #000; aspect-ratio: 1/1; 
            display: none; align-items: center; justify-content: center;
        }

        canvas, img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .accuracy-bar-bg { width: 100%; background: rgba(255, 255, 255, 0.1); height: 10px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        #accuracy-bar-fill { height: 100%; width: 0%; background: var(--accent-color); transition: width 0.3s ease; }

        .btn-main {
            background: linear-gradient(135deg, var(--primary-glow), var(--secondary-glow));
            border: none; color: white; padding: 12px; border-radius: 15px; font-weight: 700;
        }

        .btn-outline-custom {
            border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05);
            color: white; border-radius: 15px; transition: 0.3s;
        }

        .modal-content { background: #1a1635; border-radius: 20px; color: white; border: 1px solid var(--primary-glow); }
        
        .btn-back-panel {
            margin-top: 15px; border: 1px solid #ef4444; color: #ef4444;
            background: transparent; border-radius: 10px; font-size: 0.8rem;
            padding: 5px 15px; transition: 0.3s;
        }
        .btn-back-panel:hover { background: #ef4444; color: white; }

        .money-rain-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: -1; pointer-events: none;
        }
        .money-item {
            position: absolute; font-size: 2rem; opacity: 0;
            animation: fadeAndFall linear infinite;
        }
        @keyframes fadeAndFall {
            0% { opacity: 0; transform: translateY(-10vh) rotate(0deg); }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { opacity: 0; transform: translateY(110vh) rotate(720deg); }
        }
    </style>
</head>
<body>
    <div class="money-rain-container"></div>
    
    <div class="glass-card" id="mainCard">
        <h2 class="header-title">ASEAN CURRENCY AI</h2>
        
        <div class="row g-4">
            <div class="col-md-12" id="leftCol">
                <div id="manualPanel">
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <input type="number" id="amtInput" class="form-control bg-dark text-white border-secondary" value="1">
                        </div>
                        <div class="col-8">
                            <select id="curInput" class="form-select bg-dark text-white border-secondary">
                                <option value="SGD">ðŸ‡¸ðŸ‡¬ Singapore (SGD)</option>
                                <option value="THB">ðŸ‡¹ðŸ‡­ Thailand (THB)</option>
                                <option value="MYR">ðŸ‡²ðŸ‡¾ Malaysia (MYR)</option>
                                <option value="VND">ðŸ‡»ðŸ‡³ Vietnam (VND)</option>
                                <option value="LAK">ðŸ‡±ðŸ‡¦ Laos (LAK)</option>
                                <option value="MMK">ðŸ‡²ðŸ‡² Myanmar (MMK)</option>
                                <option value="USD">ðŸ‡¹ðŸ‡± Timor Leste (USD)</option>
                                <option value="PHP">ðŸ‡µðŸ‡­ Philippines (PHP)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="manualConvert()" class="btn btn-main w-100 mb-4">KONVERSI MANUAL</button>
                    <div id="resManual" class="text-center mb-4 d-none">
                        <h4 id="valManual" class="text-success fw-bold"></h4>
                    </div>
                </div>

                <div id="aiResultPanel" class="d-none">
                    <div class="p-3 text-center bg-white bg-opacity-10 rounded-4">
                        <span id="status-badge" class="badge bg-warning mb-2">SCANNING...</span>
                        <h5 id="label-name" class="text-info">Mendeteksi...</h5>
                        <h2 id="converted-val" style="color: var(--accent-color); font-weight: 800;">Rp 0</h2>
                        <div class="accuracy-bar-bg"><div id="accuracy-bar-fill"></div></div>
                        <small id="label-prob">Accuracy: 0%</small>
                        <br>
                        <button onclick="location.reload()" class="btn btn-back-panel">
                            <i class="fas fa-arrow-left me-1"></i> Kembali / Reset
                        </button>
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-6">
                        <button onclick="startMode('camera')" class="btn btn-outline-custom w-100 py-3">
                            <i class="fas fa-camera d-block mb-1"></i> Kamera
                        </button>
                    </div>
                    <div class="col-6">
                        <label class="btn btn-outline-custom w-100 py-3 mb-0" style="cursor:pointer;">
                            <i class="fas fa-crop d-block mb-1"></i> Upload & Crop
                            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileUpload(this)">
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-md-6 d-none" id="rightCol">
                <div id="media-container"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cropModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body p-0 text-center">
                    <img id="image-to-crop" style="max-width: 100%; display: block;">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" id="cropButton" class="btn btn-main">ANALISIS SEKARANG</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const URL_MODEL = "https://teachablemachine.withgoogle.com/models/_5T0OXtkr/";
    let model, webcam, isRunning = false, cropper;
    let lastResult = "";

    async function init() {
        try {
            model = await tmImage.load(URL_MODEL + "model.json", URL_MODEL + "metadata.json");
            console.log("Model Loaded");
        } catch (e) { console.error("Model Load Error"); }
    }
    init();

    async function startMode(mode) {
        document.getElementById("mainCard").classList.add("wide");
        document.getElementById("leftCol").classList.replace("col-md-12", "col-md-6");
        document.getElementById("rightCol").classList.remove("d-none");
        document.getElementById("manualPanel").classList.add("d-none");
        document.getElementById("aiResultPanel").classList.remove("d-none");
        
        const container = document.getElementById("media-container");
        container.style.display = "flex";
        container.innerHTML = ''; 

        if (mode === 'camera') {
            webcam = new tmImage.Webcam(400, 400, true); 
            await webcam.setup(); await webcam.play();
            container.appendChild(webcam.canvas);
            isRunning = true; window.requestAnimationFrame(loop);
        }
    }

    async function loop() {
        if (isRunning && webcam) { 
            webcam.update(); await predict(webcam.canvas); 
            window.requestAnimationFrame(loop); 
        }
    }

    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const imgToCrop = document.getElementById("image-to-crop");
                imgToCrop.src = e.target.result;
                const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
                cropModal.show();

                document.getElementById('cropModal').addEventListener('shown.bs.modal', () => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imgToCrop, { 
                        aspectRatio: NaN, 
                        viewMode: 1,
                        autoCropArea: 0.8
                    });
                }, { once: true });
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.getElementById("cropButton").addEventListener("click", async () => {
        const croppedCanvas = cropper.getCroppedCanvas();
        const finalCanvas = document.createElement('canvas');
        const ctx = finalCanvas.getContext('2d');
        finalCanvas.width = 224;
        finalCanvas.height = 224;
        const scale = Math.min(224 / croppedCanvas.width, 224 / croppedCanvas.height);
        const x = (224 / 2) - (croppedCanvas.width / 2) * scale;
        const y = (224 / 2) - (croppedCanvas.height / 2) * scale;
        ctx.fillStyle = "black"; 
        ctx.fillRect(0, 0, 224, 224);
        ctx.drawImage(croppedCanvas, x, y, croppedCanvas.width * scale, croppedCanvas.height * scale);
        
        bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
        isRunning = false;
        if(webcam) webcam.stop();

        await startMode('upload');
        const container = document.getElementById("media-container");
        container.innerHTML = ''; 
        const previewImg = document.createElement("img");
        previewImg.src = croppedCanvas.toDataURL(); 
        container.appendChild(previewImg);
        
        await predict(finalCanvas);
    });

    async function predict(source) {
        const prediction = await model.predict(source);
        prediction.sort((a, b) => b.probability - a.probability);
        const top = prediction[0];
        const prob = (top.probability * 100).toFixed(0);

        document.getElementById("accuracy-bar-fill").style.width = prob + "%";
        document.getElementById("label-prob").innerText = `Accuracy: ${prob}%`;

        // REVISI: Threshold diturunkan ke 0.50 agar lebih sensitif
        if (top.probability > 0.50) {
            let label = top.className.toUpperCase();
            document.getElementById("label-name").innerText = label;
            document.getElementById("status-badge").className = "badge bg-success mb-2";
            document.getElementById("status-badge").innerText = "MATCH FOUND";

            let amountMatch = label.match(/\d+/);
            let code = extractCurrencyCode(label);

            if (code && amountMatch) {
                fetchKurs(code, amountMatch[0]);
            }
        } else {
            document.getElementById("status-badge").className = "badge bg-warning mb-2";
            document.getElementById("status-badge").innerText = "SCANNING...";
        }
    }

    function extractCurrencyCode(label) {
        // Tambahkan BND dan KHR ke dalam daftar database
        const codes = ["SGD", "THB", "MYR", "VND", "LAK", "MMK", "USD", "PHP", "BND", "KHR"];
        for (let code of codes) {
            if (label.includes(code)) return code;
        }
        return null;
    }

    async function fetchKurs(cur, amt) {
        try {
            // Kita pakai SGD sebagai pengganti BND jika API tidak support BND 
            // karena nilai tukar BND dan SGD itu 1:1 (Pegged)
            let apiCur = (cur === "BND") ? "SGD" : cur;
            
            const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${apiCur}`);
            const data = await res.json();
            const total = amt * data.rates.IDR;
            
            document.getElementById("converted-val").innerText = new Intl.NumberFormat('id-ID', { 
                style: 'currency', currency: 'IDR', maximumFractionDigits: 0 
            }).format(total);
        } catch (e) { 
            console.error("API Error"); 
        }
    }

    async function manualConvert() {
        const amt = document.getElementById('amtInput').value;
        const cur = document.getElementById('curInput').value;
        try {
            const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${cur}`);
            const data = await res.json();
            document.getElementById('valManual').innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amt * data.rates.IDR);
            document.getElementById('resManual').classList.remove('d-none');
        } catch (e) { alert("Error!"); }
    }

    const moneyRainContainer = document.querySelector('.money-rain-container');
    function createMoney() {
        const money = document.createElement('div');
        money.classList.add('money-item');
        money.innerText = ['ðŸ’µ', 'ðŸª™', 'ðŸ’°', 'ðŸ’¸'][Math.floor(Math.random() * 4)];
        money.style.left = Math.random() * 100 + 'vw';
        money.style.animationDuration = (Math.random() * 3 + 4) + 's';
        moneyRainContainer.appendChild(money);
        money.addEventListener('animationend', () => money.remove());
    }
    setInterval(createMoney, 400);
</script>
</body>
</html>
